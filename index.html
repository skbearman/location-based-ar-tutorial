<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AR.js GPS – Place & Adjust Bench</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

  <!-- AR.js GPS -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: system-ui, sans-serif;
    }

    /* Place button */
    #ui {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.35);
      padding: 0.6rem 0.9rem;
      border-radius: 999px;
      z-index: 9999;
      backdrop-filter: blur(6px);
    }

    #place-btn {
      padding: 0.7rem 1.4rem;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      background: #111;
      color: #fff;
    }

    #place-btn:disabled {
      background: #555;
      opacity: 0.7;
    }

    /* Toolbar */
    #transform-ui {
      position: fixed;
      top: 0.5rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.45);
      color: #fff;
      padding: 0.6rem 0.7rem;
      border-radius: 12px;
      z-index: 9999;
      display: none;
      backdrop-filter: blur(6px);
    }

    #transform-ui h4 {
      margin: 0 0 .3rem 0;
      font-size: .85rem;
      text-align: center;
    }

    #transform-ui .row {
      display: flex;
      justify-content: center;
      gap: .3rem;
      margin-bottom: .25rem;
    }

    #transform-ui button {
      width: 44px;
      height: 44px;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      background: rgba(255,255,255,0.2);
      color: #fff;
    }

    #lock-btn {
      width: auto;
      padding: .45rem 1.1rem;
      font-size: .9rem;
      background: #ff6b6b;
      font-weight: 600;
    }
  </style>
</head>

<body>

<div id="ui">
  <button id="place-btn" disabled>Getting GPS…</button>
</div>

<div id="transform-ui">
  <h4>Adjust Bench</h4>

  <div class="row">
    <button id="move-up">↑</button>
  </div>
  <div class="row">
    <button id="move-left">←</button>
    <button id="move-down">↓</button>
    <button id="move-right">→</button>
  </div>

  <div class="row">
    <button id="height-up">Y+</button>
    <button id="height-down">Y-</button>
  </div>

  <div class="row">
    <button id="rot-left">↺</button>
    <button id="rot-right">↻</button>
  </div>

  <div class="row">
    <button id="lock-btn">Lock</button>
  </div>
</div>

<a-scene
  embedded
  vr-mode-ui="enabled:false"
  arjs="sourceType:webcam; debugUIEnabled:true"
  renderer="antialias:true; alpha:true">

  <a-camera gps-new-camera="gpsMinDistance:3; positionMinAccuracy:50"></a-camera>

</a-scene>

<script>
  const THREE = AFRAME.THREE;

  const sceneEl     = document.querySelector('a-scene');
  const cameraEl   = document.querySelector('[gps-new-camera]');
  const placeBtn   = document.getElementById('place-btn');
  const transformUI= document.getElementById('transform-ui');
  const lockBtn    = document.getElementById('lock-btn');

  let lastCoords   = null;
  let activeBench = null;

  /* GPS ready */
  cameraEl.addEventListener('gps-camera-update-position', e => {
    lastCoords = {
      latitude:  e.detail.position.latitude,
      longitude: e.detail.position.longitude
    };

    placeBtn.disabled = false;
    placeBtn.textContent = 'Place Bench Here';
  });

  /* Place bench */
  placeBtn.addEventListener('click', () => {

    if (!lastCoords) return;

    const entity = document.createElement('a-entity');

    entity.setAttribute('gltf-model','assets/park_bench.glb');
    entity.setAttribute(
      'gps-new-entity-place',
      `latitude:${lastCoords.latitude}; longitude:${lastCoords.longitude}`
    );

    entity.setAttribute('scale','1 1 1');
    entity.setAttribute('position','0 0 0');

    const forward = new THREE.Vector3();
    cameraEl.object3D.getWorldDirection(forward);
    const yaw = Math.atan2(forward.x, forward.z) * 180/Math.PI;
    entity.setAttribute('rotation',`0 ${yaw} 0`);

    sceneEl.appendChild(entity);

    activeBench = entity;
    transformUI.style.display = 'block';
  });


  /* Helper */
  function getPos(){ return activeBench?.getAttribute('position'); }
  function setPos(p){ activeBench?.setAttribute('position', p); }

  function getRot(){ return activeBench?.getAttribute('rotation'); }
  function setRot(r){ activeBench?.setAttribute('rotation', r); }

  const MOVE_STEP   = 1.5;
  const HEIGHT_STEP = 0.8;
  const ROT_STEP    = 15;

  function moveRelative(fwd,side){
    if(!activeBench) return;

    const pos = {...getPos()};
    const fwdVec = new THREE.Vector3();
    cameraEl.object3D.getWorldDirection(fwdVec);
    fwdVec.y = 0;
    fwdVec.normalize();

    const right = new THREE.Vector3(fwdVec.z, 0, -fwdVec.x);

    pos.x += (fwdVec.x*fwd + right.x*side) * MOVE_STEP;
    pos.z += (fwdVec.z*fwd + right.z*side) * MOVE_STEP;

    setPos(pos);
  }

  document.getElementById('move-up').onclick    = ()=>moveRelative(1,0);
  document.getElementById('move-down').onclick  = ()=>moveRelative(-1,0);
  document.getElementById('move-left').onclick  = ()=>moveRelative(0,-1);
  document.getElementById('move-right').onclick = ()=>moveRelative(0,1);

  document.getElementById('height-up').onclick = ()=>{
    if(!activeBench) return;
    const p={...getPos()}; p.y+=HEIGHT_STEP; setPos(p);
  };

  document.getElementById('height-down').onclick = ()=>{
    if(!activeBench) return;
    const p={...getPos()}; p.y-=HEIGHT_STEP; setPos(p);
  };

  document.getElementById('rot-left').onclick = ()=>{
    if(!activeBench) return;
    const r={...getRot()}; r.y-=ROT_STEP; setRot(r);
  };

  document.getElementById('rot-right').onclick = ()=>{
    if(!activeBench) return;
    const r={...getRot()}; r.y+=ROT_STEP; setRot(r);
  };

  lockBtn.onclick = ()=>{
    activeBench = null;
    transformUI.style.display = 'none';
  };
</script>

</body>
</html>
