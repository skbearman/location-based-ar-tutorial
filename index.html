<body>
  <!-- UI overlay -->
  <div id="ui">
    <button id="place-btn" class="btn" disabled>Getting GPS…</button>
    <button id="rot-left"  class="btn">⟲ Rotate</button>
    <button id="rot-right" class="btn">⟳ Rotate</button>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="antialias: true; alpha: true"
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: true">

    <!-- Preload model once -->
    <a-assets>
      <a-asset-item id="magnemite-gltf" src="assets/magnemite/scene.gltf"></a-asset-item>
    </a-assets>

    <!-- GPS camera -->
    <a-camera gps-new-camera="gpsMinDistance: 1"></a-camera>

  </a-scene>

  <script>
    const THREE    = AFRAME.THREE;
    const sceneEl  = document.querySelector('a-scene');
    const cameraEl = document.querySelector('[gps-new-camera]');

    const placeBtn = document.getElementById('place-btn');
    const rotLeft  = document.getElementById('rot-left');
    const rotRight = document.getElementById('rot-right');

    let selectedEntity = null;
    let gpsReady = false;

    // Mark GPS as ready when AR.js gets a position
    if (cameraEl) {
      cameraEl.addEventListener('gps-camera-update-position', (e) => {
        gpsReady = true;
        placeBtn.disabled = false;
        placeBtn.textContent = 'Place Magnemite Here';
        console.log('GPS ready:', e.detail.position);
      });
    }

    // Place a Magnemite at the camera's current GPS coordinates
    placeBtn.addEventListener('click', () => {
      if (!gpsReady) {
        // Non-blocking feedback instead of alert()
        placeBtn.textContent = 'Still getting GPS…';
        return;
      }

      const gpsComp = cameraEl.components['gps-new-camera'];
      if (!gpsComp || !gpsComp.currentCoords) {
        placeBtn.textContent = 'No GPS coords yet…';
        return;
      }

      const { latitude, longitude } = gpsComp.currentCoords;

      const entity = document.createElement('a-entity');
      entity.setAttribute('gltf-model', '#magnemite-gltf');
      entity.setAttribute(
        'gps-new-entity-place',
        `latitude: ${latitude}; longitude: ${longitude}`
      );
      entity.setAttribute('scale', '1 1 1');
      entity.setAttribute('position', '0 0 0');

      // Face camera at placement time
      const forward = new THREE.Vector3();
      cameraEl.object3D.getWorldDirection(forward);
      const yaw = Math.atan2(forward.x, forward.z) * 180 / Math.PI;
      entity.setAttribute('rotation', `0 ${yaw} 0`);

      sceneEl.appendChild(entity);
      selectedEntity = entity;

      console.log('Placed Magnemite at', latitude, longitude, 'yaw', yaw);
    });

    // Rotate helpers for last placed Magnemite
    function rotateSelected(deltaDeg) {
      if (!selectedEntity) return;
      const rot = selectedEntity.getAttribute('rotation') || {x: 0, y: 0, z: 0};
      selectedEntity.setAttribute('rotation', `0 ${rot.y + deltaDeg} 0`);
    }

    rotLeft.addEventListener('click',  () => rotateSelected(-15));
    rotRight.addEventListener('click', () => rotateSelected(15));
  </script>
</body>
