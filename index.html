<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AR.js GPS + Place Magnemite</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

  <!-- AR.js with GPS location -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #ui {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      z-index: 10;
      background: rgba(0,0,0,0.3);
      padding: 0.5rem 0.75rem;
      border-radius: 999px;
      backdrop-filter: blur(6px);
    }

    #place-btn {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      background: #111;
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }

    #place-btn:disabled {
      background: #555;
      opacity: 0.7;
    }
  </style>
</head>

<body>

  <!-- Simple UI overlay -->
  <div id="ui">
    <button id="place-btn" disabled>Getting GPS…</button>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: true"
    renderer="antialias: true; alpha: true">

    <!-- This SHOULD always show if AR is running -->
    <a-box position="0 0 -2" color="blue"></a-box>

    <!-- GPS camera -->
   <a-camera gps-new-camera="gpsMinDistance: 3; positionMinAccuracy: 50"></a-camera>

    <!-- Red GPS box at your coordinates (smaller + pushed forward) -->
    <a-box
      color="red"
      depth="2" height="2" width="2"
      gps-new-entity-place="latitude: 33.45679; longitude: -111.77721">
    </a-box>

    <!-- Magnemite at the SAME GPS location (smaller + forward) -->
    <a-entity
      id="static-magnemite"
      gltf-model="assets/magnemite/scene.gltf"
      rotation="0 180 0"
      scale="0.2 0.2 0.2"
      gps-new-entity-place="latitude: 33.45679; longitude: -111.77721"
      animation-mixer>
    </a-entity>

  </a-scene>

  <script>
    const THREE     = AFRAME.THREE;
    const sceneEl   = document.querySelector('a-scene');
    const cameraEl  = document.querySelector('[gps-new-camera]');
    const placeBtn  = document.getElementById('place-btn');

    let lastCoords = null;

    // When GPS updates, remember coords and enable the button
    cameraEl.addEventListener('gps-camera-update-position', (e) => {
      const pos = e.detail.position;
      lastCoords = {
        latitude: pos.latitude,
        longitude: pos.longitude
      };

      placeBtn.disabled = false;
      placeBtn.textContent = 'Place Magnemite Here';
      console.log('GPS update:', lastCoords);
    });

    // On click, place a new Magnemite at the current GPS position
    placeBtn.addEventListener('click', () => {
      if (!lastCoords) {
        placeBtn.textContent = 'Still getting GPS…';
        setTimeout(() => {
          placeBtn.textContent = 'Place Magnemite Here';
        }, 1500);
        return;
      }

      const { latitude, longitude } = lastCoords;

      const entity = document.createElement('a-entity');
      entity.setAttribute('gltf-model', 'assets/magnemite/scene.gltf');
      entity.setAttribute(
        'gps-new-entity-place',
        `latitude: ${latitude}; longitude: ${longitude}`
      );
      entity.setAttribute('scale', '0.2 0.2 0.2');
      // local offset so it appears in front of you, not on your exact feet
      entity.setAttribute('position', '0 1 0');

      // Make it face the direction you're looking when you place it
      const forward = new THREE.Vector3();
      cameraEl.object3D.getWorldDirection(forward);
      const yaw = Math.atan2(forward.x, forward.z) * 180 / Math.PI;
      entity.setAttribute('rotation', `0 ${yaw} 0`);

      sceneEl.appendChild(entity);

      console.log('Placed Magnemite at', latitude, longitude, 'yaw', yaw);
    });
  </script>

</body>
</html>
