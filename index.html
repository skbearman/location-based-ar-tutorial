<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tap-to-Place Magnemite</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

  <!-- AR.js (non-GPS, camera-based AR) -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }

    #ui {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 0.5rem;
      z-index: 10;
      font-family: system-ui, sans-serif;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      background: #222;
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      opacity: 0.9;
    }
  </style>
</head>

<body>

  <!-- Simple UI overlay -->
  <div id="ui">
    <button id="rot-left" class="btn">⟲ Rotate Left</button>
    <button id="rot-right" class="btn">⟳ Rotate Right</button>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="antialias: true; alpha: true"
    arjs="sourceType: webcam; debugUIEnabled: true">

    <!-- Preload model -->
    <a-assets>
      <a-asset-item id="magnemite-gltf" src="assets/magnemite/scene.gltf"></a-asset-item>
    </a-assets>

    <!-- Camera with mouse-based raycaster (tap/click) -->
    <a-camera
      id="camera"
      position="0 1.6 0"
      cursor="rayOrigin: mouse"
      raycaster="objects: .click-target">
    </a-camera>

    <!-- Invisible "ground" plane to receive taps -->
    <a-entity id="ground"
      class="click-target"
      geometry="primitive: plane; width: 20; height: 20"
      material="transparent: true; opacity: 0"
      position="0 0 -4"
      rotation="-90 0 0">
    </a-entity>

  </a-scene>

  <script>
    const THREE = AFRAME.THREE; // use A-Frame's bundled THREE
    let selectedEntity = null;

    const ground = document.getElementById('ground');
    const cameraEl = document.getElementById('camera');
    const sceneEl = document.querySelector('a-scene');

    // Tap on the ground plane to place a Magnemite
    ground.addEventListener('click', evt => {
      const intersection = evt.detail.intersection;
      if (!intersection) return;

      const point = intersection.point; // {x, y, z} in world space

      // Create a new Magnemite entity
      const entity = document.createElement('a-entity');
      entity.setAttribute('gltf-model', '#magnemite-gltf');
      entity.setAttribute('scale', '1 1 1');
      entity.setAttribute('position', `${point.x} ${point.y} ${point.z}`);

      // Make it face the user at placement time
      const camWorldPos = new THREE.Vector3();
      cameraEl.object3D.getWorldPosition(camWorldPos);

      const dx = camWorldPos.x - point.x;
      const dz = camWorldPos.z - point.z;
      const yaw = Math.atan2(dx, dz) * 180 / Math.PI; // convert to degrees

      entity.setAttribute('rotation', `0 ${yaw} 0`);

      sceneEl.appendChild(entity);
      selectedEntity = entity;
    });

    // Rotate helpers
    function rotateSelected(deltaDeg) {
      if (!selectedEntity) return;
      const rot = selectedEntity.getAttribute('rotation') || {x: 0, y: 0, z: 0};
      const newY = rot.y + deltaDeg;
      selectedEntity.setAttribute('rotation', `0 ${newY} 0`);
    }

    document.getElementById('rot-left').addEventListener('click', () => {
      rotateSelected(-15); // rotate 15° left
    });

    document.getElementById('rot-right').addEventListener('click', () => {
      rotateSelected(15); // rotate 15° right
    });
  </script>

</body>
</html>

