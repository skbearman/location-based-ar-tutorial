<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AR.js GPS + Place & Adjust Bench</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

  <!-- AR.js with GPS location -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* Place button UI */
    #ui {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      z-index: 10;
      background: rgba(0,0,0,0.3);
      padding: 0.5rem 0.75rem;
      border-radius: 999px;
      backdrop-filter: blur(6px);
    }

    #place-btn {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      background: #111;
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }

    #place-btn:disabled {
      background: #555;
      opacity: 0.7;
    }

    /* Transform controls UI */
    #transform-ui {
      position: fixed;
      top: 0.5rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 15;
      background: rgba(0,0,0,0.4);
      color: #fff;
      padding: 0.5rem 0.75rem;
      border-radius: 12px;
      backdrop-filter: blur(6px);
      font-size: 0.75rem;
      display: none; /* hidden until we have a Magnemite */
    }

    #transform-ui h4 {
      margin: 0 0 0.3rem 0;
      font-size: 0.8rem;
      text-align: center;
    }

    #transform-ui .row {
      display: flex;
      justify-content: center;
      gap: 0.25rem;
      margin-bottom: 0.25rem;
    }

    #transform-ui button {
      border: none;
      border-radius: 6px;
      padding: 0.2rem 0.4rem;
      background: rgba(255,255,255,0.2);
      color: #fff;
      font-size: 0.75rem;
      min-width: 2rem;
    }

    #lock-btn {
      background: #ff6b6b;
      font-weight: 600;
      padding-inline: 0.6rem;
    }
  </style>
</head>

<body>

  <!-- Simple UI overlay: place at current GPS -->
  <div id="ui">
    <button id="place-btn" disabled>Getting GPS…</button>
  </div>

  <!-- Transform controls overlay -->
  <div id="transform-ui">
    <h4>Adjust Bench</h4>

    <!-- Move controls -->
    <div class="row">
      <button id="move-up">↑</button>
    </div>
    <div class="row">
      <button id="move-left">←</button>
      <button id="move-down">↓</button>
      <button id="move-right">→</button>
    </div>

    <!-- Height controls -->
    <div class="row">
      <button id="height-up">Y+</button>
      <button id="height-down">Y-</button>
    </div>

    <!-- Rotation controls -->
    <div class="row">
      <button id="rot-left">↺</button>
      <button id="rot-right">↻</button>
    </div>

    <!-- Lock button -->
    <div class="row">
      <button id="lock-btn">Lock</button>
    </div>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: true"
    renderer="antialias: true; alpha: true">

    <!-- Always-visible debug cube -->
    <a-box position="0 0 -2" color="blue"></a-box>

    <!-- GPS camera -->
    <a-camera gps-new-camera="gpsMinDistance: 3; positionMinAccuracy: 50"></a-camera>

    <!-- Example static GPS objects -->
    <a-box
      color="red"
      depth="2" height="2" width="2"
      gps-new-entity-place="latitude: 33.45679; longitude: -111.77721"
      position="0 0 0">
    </a-box>

    <!-- <a-entity
      id="static-bench"
      gltf-model="assets/park_bench.glb"
      rotation="0 0 0"
      scale="1 1 1"
      gps-new-entity-place="latitude: 33.45679; longitude: -111.77721"
      position="0 0 0">
    </a-entity> -->


  </a-scene>

 <script>
  const THREE       = AFRAME.THREE;
  const sceneEl     = document.querySelector('a-scene');
  const cameraEl    = document.querySelector('[gps-new-camera]');
  const placeBtn    = document.getElementById('place-btn');
  const transformUI = document.getElementById('transform-ui');
  const lockBtn     = document.getElementById('lock-btn');

  let lastCoords = null;
  let activeBench = null; // last placed bench that we're editing

  // When GPS updates, remember coords and enable the button
  cameraEl.addEventListener('gps-camera-update-position', (e) => {
    const pos = e.detail.position;
    lastCoords = {
      latitude: pos.latitude,
      longitude: pos.longitude
    };

    placeBtn.disabled = false;
    placeBtn.textContent = 'Place Bench Here';
    console.log('GPS update:', lastCoords);
  });

  // On click, place a new Bench at the current GPS position
  placeBtn.addEventListener('click', () => {
    if (!lastCoords) {
      placeBtn.textContent = 'Still getting GPS…';
      setTimeout(() => {
        placeBtn.textContent = 'Place Bench Here';
      }, 1500);
      return;
    }

    const { latitude, longitude } = lastCoords;

    const entity = document.createElement('a-entity');
    entity.setAttribute('gltf-model', 'assets/park_bench.glb');
    entity.setAttribute(
      'gps-new-entity-place',
      `latitude: ${latitude}; longitude: ${longitude}`
    );
    entity.setAttribute('scale', '1 1 1');

    // Start with no local X/Z offset; Y = 0 (on ground)
    entity.setAttribute('position', '0 0 0');

    // Make it face the direction you're looking when you place it
    const forward = new THREE.Vector3();
    cameraEl.object3D.getWorldDirection(forward);
    const yaw = Math.atan2(forward.x, forward.z) * 180 / Math.PI;
    entity.setAttribute('rotation', `0 ${yaw} 0`);

    sceneEl.appendChild(entity);

    // Set this as the active bench for editing
    activeBench = entity;
    transformUI.style.display = 'block';

    console.log('Placed bench at', latitude, longitude, 'yaw', yaw);
  });

  // --- Transform controls for activeBench ---

  function getPos() {
    if (!activeBench) return null;
    return Object.assign({}, activeBench.getAttribute('position'));
  }

  function setPos(pos) {
    if (!activeBench) return;
    activeBench.setAttribute('position', pos);
  }

  function getRot() {
    if (!activeBench) return null;
    return Object.assign({}, activeBench.getAttribute('rotation'));
  }

  function setRot(rot) {
    if (!activeBench) return;
    activeBench.setAttribute('rotation', rot);
  }

  const MOVE_STEP   = 2.0;
  const HEIGHT_STEP = 2.5;
  const ROT_STEP    = 15; // degrees

  function moveRelative(forwardSign, rightSign) {
    if (!activeBench) return;

    const pos = getPos();
    if (!pos) return;

    const forward = new THREE.Vector3();
    cameraEl.object3D.getWorldDirection(forward);
    forward.y = 0;
    forward.normalize();

    const right = new THREE.Vector3(forward.z, 0, -forward.x);

    const dx = (forward.x * forwardSign + right.x * rightSign) * MOVE_STEP;
    const dz = (forward.z * forwardSign + right.z * rightSign) * MOVE_STEP;

    pos.x += dx;
    pos.z += dz;

    setPos(pos);
  }

  document.getElementById('move-up').addEventListener('click', () => {
    moveRelative(1, 0); // forward
  });

  document.getElementById('move-down').addEventListener('click', () => {
    moveRelative(-1, 0); // backward
  });

  document.getElementById('move-left').addEventListener('click', () => {
    moveRelative(0, -1); // left
  });

  document.getElementById('move-right').addEventListener('click', () => {
    moveRelative(0, 1); // right
  });

  document.getElementById('height-up').addEventListener('click', () => {
    if (!activeBench) return;
    const pos = getPos();
    pos.y += HEIGHT_STEP;
    setPos(pos);
  });

  document.getElementById('height-down').addEventListener('click', () => {
    if (!activeBench) return;
    const pos = getPos();
    pos.y -= HEIGHT_STEP;
    setPos(pos);
  });

  document.getElementById('rot-left').addEventListener('click', () => {
    if (!activeBench) return;
    const rot = getRot();
    rot.y -= ROT_STEP;
    setRot(rot);
  });

  document.getElementById('rot-right').addEventListener('click', () => {
    if (!activeBench) return;
    const rot = getRot();
    rot.y += ROT_STEP;
    setRot(rot);
  });

  // Lock button: hide toolbar and stop editing this bench
  lockBtn.addEventListener('click', () => {
    activeBench = null;
    transformUI.style.display = 'none';
  });
</script>


</body>
</html>
