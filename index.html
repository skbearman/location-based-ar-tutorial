<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GPS-anchored Magnemite</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

  <!-- AR.js location-only + A-Frame integration -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }

    #ui {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      display: flex;
      gap: 0.5rem;
      font-family: system-ui, sans-serif;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: none;
      font-size: 0.85rem;
      font-weight: 600;
      background: #222;
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      opacity: 0.9;
    }
  </style>
</head>

<body>

  <!-- UI overlay -->
  <div id="ui">
    <button id="place-btn" class="btn">Place Magnemite Here</button>
    <button id="rot-left"  class="btn">⟲ Rotate</button>
    <button id="rot-right" class="btn">⟳ Rotate</button>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="antialias: true; alpha: true"
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: true">

    <!-- Preload model once -->
    <a-assets>
      <a-asset-item id="magnemite-gltf" src="assets/magnemite/scene.gltf"></a-asset-item>
    </a-assets>

    <!-- GPS camera -->
    <a-camera gps-new-camera="gpsMinDistance: 1"></a-camera>

    <!-- Optional: known debug anchor (e.g., your room coord) -->
    <!--
    <a-box
      color="red"
      depth="10" height="10" width="10"
      gps-new-entity-place="latitude: 33.45679; longitude: -111.77721">
    </a-box>
    -->

  </a-scene>

  <script>
    const THREE = AFRAME.THREE;
    const sceneEl   = document.querySelector('a-scene');
    const cameraEl  = document.querySelector('[gps-new-camera]');
    const placeBtn  = document.getElementById('place-btn');
    const rotLeft   = document.getElementById('rot-left');
    const rotRight  = document.getElementById('rot-right');

    let selectedEntity = null;

    // Place a Magnemite at the camera's current GPS coordinates
    placeBtn.addEventListener('click', () => {
      if (!cameraEl) {
        console.warn('No gps-new-camera found.');
        return;
      }

      const gpsComp = cameraEl.components['gps-new-camera'];
      if (!gpsComp || !gpsComp.currentCoords) {
        alert('Still getting GPS fix… go outside and wait a few seconds.');
        return;
      }

      const { latitude, longitude } = gpsComp.currentCoords;

      // Create entity anchored at this lat/long
      const entity = document.createElement('a-entity');
      entity.setAttribute('gltf-model', '#magnemite-gltf');
      entity.setAttribute('gps-new-entity-place',
        `latitude: ${latitude}; longitude: ${longitude}`
      );
      entity.setAttribute('scale', '1 1 1');

      // Optional: a small local offset so it's not exactly at your feet
      entity.setAttribute('position', '0 0 0');

      // Make it face the camera at placement time
      const camDir = new THREE.Vector3();
      cameraEl.object3D.getWorldDirection(camDir); // forward vector

      const yaw = Math.atan2(camDir.x, camDir.z) * 180 / Math.PI;
      entity.setAttribute('rotation', `0 ${yaw} 0`);

      sceneEl.appendChild(entity);
      selectedEntity = entity;

      console.log('Placed Magnemite at', latitude, longitude, 'yaw', yaw);
    });

    // Rotate helpers for the *last placed* Magnemite
    function rotateSelected(deltaDeg) {
      if (!selectedEntity) return;
      const rot = selectedEntity.getAttribute('rotation') || {x: 0, y: 0, z: 0};
      selectedEntity.setAttribute('rotation', `0 ${rot.y + deltaDeg} 0`);
    }

    rotLeft.addEventListener('click', ()  => rotateSelected(-15));
    rotRight.addEventListener('click', () => rotateSelected(15));
  </script>

</body>
</html>
